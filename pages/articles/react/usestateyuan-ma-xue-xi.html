<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>useState源码学习 | frenchleave</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="冯春齐 fengchunqi frenchleave blog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="冯春齐,fengchunqi,frenchleave blog">
    
    <link rel="preload" href="/assets/css/0.styles.a4a619a0.css" as="style"><link rel="preload" href="/assets/js/app.18b294a3.js" as="script"><link rel="preload" href="/assets/js/3.7300aef9.js" as="script"><link rel="preload" href="/assets/js/1.cfd142c1.js" as="script"><link rel="preload" href="/assets/js/103.595e0ae4.js" as="script"><link rel="preload" href="/assets/js/11.ae2268d9.js" as="script"><link rel="prefetch" href="/assets/js/10.4c13b9ab.js"><link rel="prefetch" href="/assets/js/100.cbef5c72.js"><link rel="prefetch" href="/assets/js/101.121834b0.js"><link rel="prefetch" href="/assets/js/102.65ded4ff.js"><link rel="prefetch" href="/assets/js/104.3762c07a.js"><link rel="prefetch" href="/assets/js/105.050b0428.js"><link rel="prefetch" href="/assets/js/106.c33f60fc.js"><link rel="prefetch" href="/assets/js/107.da124dc8.js"><link rel="prefetch" href="/assets/js/108.9115ff99.js"><link rel="prefetch" href="/assets/js/109.5b9b06e1.js"><link rel="prefetch" href="/assets/js/110.bf877426.js"><link rel="prefetch" href="/assets/js/111.ebe12655.js"><link rel="prefetch" href="/assets/js/112.6000020b.js"><link rel="prefetch" href="/assets/js/113.81c06da3.js"><link rel="prefetch" href="/assets/js/114.488cba0a.js"><link rel="prefetch" href="/assets/js/115.d5323a20.js"><link rel="prefetch" href="/assets/js/116.2bb0b110.js"><link rel="prefetch" href="/assets/js/117.07baa2a7.js"><link rel="prefetch" href="/assets/js/118.6d70107b.js"><link rel="prefetch" href="/assets/js/119.323f4b8e.js"><link rel="prefetch" href="/assets/js/12.ce50290d.js"><link rel="prefetch" href="/assets/js/120.2d02c4e7.js"><link rel="prefetch" href="/assets/js/121.3e996ad8.js"><link rel="prefetch" href="/assets/js/122.dc8ca607.js"><link rel="prefetch" href="/assets/js/123.862509c2.js"><link rel="prefetch" href="/assets/js/124.6e46b09a.js"><link rel="prefetch" href="/assets/js/125.55a98ccd.js"><link rel="prefetch" href="/assets/js/126.b1469586.js"><link rel="prefetch" href="/assets/js/127.a74a9e31.js"><link rel="prefetch" href="/assets/js/128.26faca6e.js"><link rel="prefetch" href="/assets/js/129.f5c4f743.js"><link rel="prefetch" href="/assets/js/13.3d29ecc1.js"><link rel="prefetch" href="/assets/js/130.feee2a84.js"><link rel="prefetch" href="/assets/js/131.32603aa7.js"><link rel="prefetch" href="/assets/js/132.e2e549f9.js"><link rel="prefetch" href="/assets/js/133.59a36eeb.js"><link rel="prefetch" href="/assets/js/134.af99d758.js"><link rel="prefetch" href="/assets/js/135.94f100a0.js"><link rel="prefetch" href="/assets/js/136.28b66332.js"><link rel="prefetch" href="/assets/js/137.345bc981.js"><link rel="prefetch" href="/assets/js/138.65044ee0.js"><link rel="prefetch" href="/assets/js/139.e7816252.js"><link rel="prefetch" href="/assets/js/14.9bf65165.js"><link rel="prefetch" href="/assets/js/140.aeda878e.js"><link rel="prefetch" href="/assets/js/141.9b334600.js"><link rel="prefetch" href="/assets/js/142.468ac6a9.js"><link rel="prefetch" href="/assets/js/143.94425108.js"><link rel="prefetch" href="/assets/js/144.2f5bc598.js"><link rel="prefetch" href="/assets/js/145.57c8b023.js"><link rel="prefetch" href="/assets/js/146.6949efbb.js"><link rel="prefetch" href="/assets/js/15.51e59a06.js"><link rel="prefetch" href="/assets/js/16.181c0fea.js"><link rel="prefetch" href="/assets/js/17.b0e9fd56.js"><link rel="prefetch" href="/assets/js/18.87503b74.js"><link rel="prefetch" href="/assets/js/19.ba40ec37.js"><link rel="prefetch" href="/assets/js/20.7e19db51.js"><link rel="prefetch" href="/assets/js/21.d40083aa.js"><link rel="prefetch" href="/assets/js/22.93654aff.js"><link rel="prefetch" href="/assets/js/23.a07d0e82.js"><link rel="prefetch" href="/assets/js/24.69d1b822.js"><link rel="prefetch" href="/assets/js/25.ccf68f0f.js"><link rel="prefetch" href="/assets/js/26.a5687f17.js"><link rel="prefetch" href="/assets/js/27.45338362.js"><link rel="prefetch" href="/assets/js/28.fb6e7fef.js"><link rel="prefetch" href="/assets/js/29.e55e72a5.js"><link rel="prefetch" href="/assets/js/30.a3c4e2f0.js"><link rel="prefetch" href="/assets/js/31.ebf52703.js"><link rel="prefetch" href="/assets/js/32.d43823ef.js"><link rel="prefetch" href="/assets/js/33.ce438395.js"><link rel="prefetch" href="/assets/js/34.5e2646e4.js"><link rel="prefetch" href="/assets/js/35.7c9bcc29.js"><link rel="prefetch" href="/assets/js/36.83aec074.js"><link rel="prefetch" href="/assets/js/37.90e3d82c.js"><link rel="prefetch" href="/assets/js/38.c383baf8.js"><link rel="prefetch" href="/assets/js/39.da96f8c2.js"><link rel="prefetch" href="/assets/js/4.f1fcdff6.js"><link rel="prefetch" href="/assets/js/40.5a55b4dd.js"><link rel="prefetch" href="/assets/js/41.f803ba0f.js"><link rel="prefetch" href="/assets/js/42.2bd5c0f5.js"><link rel="prefetch" href="/assets/js/43.66c8fa3d.js"><link rel="prefetch" href="/assets/js/44.bb035d1d.js"><link rel="prefetch" href="/assets/js/45.bbcafbc2.js"><link rel="prefetch" href="/assets/js/46.153fc87d.js"><link rel="prefetch" href="/assets/js/47.9710bb1c.js"><link rel="prefetch" href="/assets/js/48.dad77d8e.js"><link rel="prefetch" href="/assets/js/49.d4df2f95.js"><link rel="prefetch" href="/assets/js/5.9ed980da.js"><link rel="prefetch" href="/assets/js/50.398b02dc.js"><link rel="prefetch" href="/assets/js/51.42da478d.js"><link rel="prefetch" href="/assets/js/52.3747d924.js"><link rel="prefetch" href="/assets/js/53.c501dacf.js"><link rel="prefetch" href="/assets/js/54.5576c25b.js"><link rel="prefetch" href="/assets/js/55.047030b4.js"><link rel="prefetch" href="/assets/js/56.d76e9104.js"><link rel="prefetch" href="/assets/js/57.df596f48.js"><link rel="prefetch" href="/assets/js/58.fa8886cf.js"><link rel="prefetch" href="/assets/js/59.5d59112d.js"><link rel="prefetch" href="/assets/js/6.36581b04.js"><link rel="prefetch" href="/assets/js/60.10461f91.js"><link rel="prefetch" href="/assets/js/61.4a55c836.js"><link rel="prefetch" href="/assets/js/62.bda2cdeb.js"><link rel="prefetch" href="/assets/js/63.436d95f5.js"><link rel="prefetch" href="/assets/js/64.7050a83b.js"><link rel="prefetch" href="/assets/js/65.74013dae.js"><link rel="prefetch" href="/assets/js/66.4020ece9.js"><link rel="prefetch" href="/assets/js/67.a53afb93.js"><link rel="prefetch" href="/assets/js/68.57f8126a.js"><link rel="prefetch" href="/assets/js/69.2dc8526f.js"><link rel="prefetch" href="/assets/js/7.19c1e33e.js"><link rel="prefetch" href="/assets/js/70.90352d44.js"><link rel="prefetch" href="/assets/js/71.4d300dfc.js"><link rel="prefetch" href="/assets/js/72.c1beb098.js"><link rel="prefetch" href="/assets/js/73.7bdbed45.js"><link rel="prefetch" href="/assets/js/74.51c6a007.js"><link rel="prefetch" href="/assets/js/75.0cf56900.js"><link rel="prefetch" href="/assets/js/76.59c03f4c.js"><link rel="prefetch" href="/assets/js/77.bfa3da09.js"><link rel="prefetch" href="/assets/js/78.0fa410bc.js"><link rel="prefetch" href="/assets/js/79.162ba733.js"><link rel="prefetch" href="/assets/js/8.4b2dcb4b.js"><link rel="prefetch" href="/assets/js/80.086011cb.js"><link rel="prefetch" href="/assets/js/81.f19fb83c.js"><link rel="prefetch" href="/assets/js/82.ab4d4fa2.js"><link rel="prefetch" href="/assets/js/83.ff0a7bc1.js"><link rel="prefetch" href="/assets/js/84.e4c96191.js"><link rel="prefetch" href="/assets/js/85.4b728501.js"><link rel="prefetch" href="/assets/js/86.131b3a04.js"><link rel="prefetch" href="/assets/js/87.a16de27a.js"><link rel="prefetch" href="/assets/js/88.66948c74.js"><link rel="prefetch" href="/assets/js/89.4208b96c.js"><link rel="prefetch" href="/assets/js/9.7c9ca731.js"><link rel="prefetch" href="/assets/js/90.b91a3ace.js"><link rel="prefetch" href="/assets/js/91.412ff125.js"><link rel="prefetch" href="/assets/js/92.7374bf7f.js"><link rel="prefetch" href="/assets/js/93.0a3cfe30.js"><link rel="prefetch" href="/assets/js/94.2434355e.js"><link rel="prefetch" href="/assets/js/95.963ecd71.js"><link rel="prefetch" href="/assets/js/96.77790717.js"><link rel="prefetch" href="/assets/js/97.32496f2d.js"><link rel="prefetch" href="/assets/js/98.ef1142c3.js"><link rel="prefetch" href="/assets/js/99.7cbf0487.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a4a619a0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>frenchleave</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>冯春齐 fengchunqi frenchleave blog</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>fengchunqi</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2024
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.jpg" alt="frenchleave" class="logo"> <span class="site-name">frenchleave</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/About/" class="nav-link"><i class="undefined"></i>
  About
</a></li><li class="dropdown-item"><!----> <a href="/categories/Articles/" class="nav-link"><i class="undefined"></i>
  Articles
</a></li><li class="dropdown-item"><!----> <a href="/categories/Poem/" class="nav-link"><i class="undefined"></i>
  Poem
</a></li><li class="dropdown-item"><!----> <a href="/categories/Study/" class="nav-link"><i class="undefined"></i>
  Study
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/pages/comments/" class="nav-link"><i class="iconfont reco-suggestion"></i>
  留言板
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      更多
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/about/author.html" class="nav-link"><i class="undefined"></i>
  关于作者
</a></li><li class="dropdown-item"><!----> <a href="/pages/about/website.html" class="nav-link"><i class="undefined"></i>
  关于本站
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    fengchunqi
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>115</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>20</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/About/" class="nav-link"><i class="undefined"></i>
  About
</a></li><li class="dropdown-item"><!----> <a href="/categories/Articles/" class="nav-link"><i class="undefined"></i>
  Articles
</a></li><li class="dropdown-item"><!----> <a href="/categories/Poem/" class="nav-link"><i class="undefined"></i>
  Poem
</a></li><li class="dropdown-item"><!----> <a href="/categories/Study/" class="nav-link"><i class="undefined"></i>
  Study
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/pages/comments/" class="nav-link"><i class="iconfont reco-suggestion"></i>
  留言板
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      更多
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/about/author.html" class="nav-link"><i class="undefined"></i>
  关于作者
</a></li><li class="dropdown-item"><!----> <a href="/pages/about/website.html" class="nav-link"><i class="undefined"></i>
  关于本站
</a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Algorithm</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Interview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NPM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/articles/react/react-hookxue-xi.html" class="sidebar-link">React Hook学习</a></li><li><a href="/pages/articles/react/usestateyuan-ma-xue-xi.html" aria-current="page" class="active sidebar-link">useState源码学习</a></li><li><a href="/pages/articles/react/chang-yong-hook.html" class="sidebar-link">常用Hook</a></li><li><a href="/pages/articles/react/shou-kong-zu-jian-he-fei-shou-kong-zu-jian.html" class="sidebar-link">受控组件和非受控组件</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>VSCode</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>useState源码学习</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>fengchunqi</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2024
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">useState源码学习</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>fengchunqi</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2022/10/29</span></i> <i class="iconfont reco-eye" data-v-1ff7123e><span id="/pages/articles/react/usestateyuan-ma-xue-xi.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1ff7123e><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>React</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="usestate的使用"><a href="#usestate的使用" class="header-anchor">#</a> useState的使用</h2> <p>Hook写法：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'orange'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>price<span class="token punctuation">,</span> setPrice<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>class的写法：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">,</span>
      price<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>疑问：</p> <ol><li>React怎么知道哪个state对应哪个<code>useState</code>？Function Component不像Class Component那样可以将私有状态挂载到类实例中并通过对应的<code>key</code>来指向对应的状态，而且每次的页面的刷新或者说组件的重新渲染都会使得Function重新执行一遍。所以React中必定有一种机制来区分这些Hooks。</li> <li>React是如何在每次重新渲染之后都能返回最新的状态？Class Component因为自身的特点可以将私有状态持久化的挂载到类实例上，每时每刻保存的都是最新的值。而Function Component由于本质就是一个函数，并且每次渲染都会重新执行。所以React必定拥有某种机制去记住每一次的更新操作，并最终得出最新的值返回。当然我们还会有其他的一些问题，比如这些状态究竟存放在哪？为什么只能在函数顶层使用Hooks而不能在条件语句等里面使用Hooks？</li></ol> <details class="custom-block details"><summary>DETAILS</summary> <p>函数组件通过<code>renderWithHooks</code>函数可以确定当前的<code>workInProgress</code>节点，通过是否存在<code>current</code>节点来判断当前是在Mount阶段还是Update阶段，并获取相应阶段的<code>ReactCurrentDispatcher</code>，执行函数组件自己来获取自身的<code>children</code>。</p> <p>在执行过程中，会执行对应阶段的hook函数，函数组件的hooks是单向链表结构，存储在Fiber节点的<code>memoizedState</code>属性上，通过<code>next</code>指针（<code>hook.next</code>）依序获取下一个hook对象。在hook对象的<code>queue</code>属性上，存储着hook的更新队列，它是环形单向链表，<code>queue.pending</code>指向最新的update，<code>queue.pending.next</code>则指向的是第一个update。通过执行<code>mountWorkInProgressHook</code>来创建一个新的hook对象，然后返回初始state和触发action的dispatch，通过执行<code>updateReducer</code>来处理<code>queue</code>中的update以获取最新的state。调用dispatch触发action，发起更新任务调度，同时在<code>dispatchAction</code>里计算最新的state，并更新<code>queue</code>环形链表，然后执行<code>scheduleUpdateOnFiber</code>，进入调度，再次进入到<code>renderWithHooks</code>，执行<code>updateReducer</code>，得到新的state值返回，并重新计算渲染。</p></details> <p>Function Component Fiber节点：</p> <ul><li>type：指向Component，可能是Function Component，也可能是Class Component等其他组件。对Function Component来说，就是一个具体的render函数，比如上面的<code>Example</code>函数。</li> <li>memoizedState：指向自身状态，在Class Fiber下是构造函数声明的state，在Function Fiber下则是一个Hook池。Hook池中维护着组件调用<code>useXXX</code>产生的所有Hook，Hook中又分别记着各自的状态。</li></ul> <div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <p>在项目中使用Hook，必须先引入</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react/src/ReactHooks.js</span>
<span class="token keyword">import</span> ReactCurrentDispatcher <span class="token keyword">from</span> <span class="token string">'./ReactCurrentDispatcher'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> ReactCurrentDispatcher<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dispatcher<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> Dispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatcher <span class="token operator">=</span> <span class="token function">resolveDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从源码中可以看到，我们调用的其实是ReactCurrentDispatcher.js中的<code>dispatcher.useState()</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react/src/ReactCurrentDispatcher.js</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span>Dispatcher<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-reconciler/src/ReactInternalTypes'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Keeps track of the current dispatcher.
 */</span>
<span class="token keyword">const</span> ReactCurrentDispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  current<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Dispatcher<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ReactCurrentDispatcher<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>Dispatcher</code>的声明：</p> <div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactInternalTypes.js</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Dispatcher</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  use<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>Usable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  <span class="token generic-function"><span class="token function">readContext</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token generic-function"><span class="token function">useReducer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
    <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
    initialArg<span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span>
    init<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token constant">I</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token generic-function"><span class="token function">useContext</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>initialValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>current<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 其余Hook的类型定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在“react/packages/react-reconciler/src/ReactFiberHooks.new.js”下的<code>useState</code>的具体实现：</p> <p>全局变量：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token comment">// 渲染优先级</span>
<span class="token keyword">let</span> renderLanes<span class="token operator">:</span> Lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

<span class="token comment">// 当前正在构造的fiber, 等同于 workInProgress, 为了和当前hook区分, 所以将其改名</span>
<span class="token keyword">let</span> currentlyRenderingFiber<span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Hooks被存储在fiber.memoizedState链表上</span>
<span class="token comment">// 指向current.memoizedState</span>
<span class="token keyword">let</span> currentHook<span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// currentHook = fiber(current).memoizedState</span>
<span class="token comment">// 指向workInProgress.memoizedState</span>
<span class="token keyword">let</span> workInProgressHook<span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// workInProgressHook = fiber(workInProgress).memoizedState</span>

<span class="token comment">// 在function的执行过程中, 是否再次发起了更新. 只有function被完全执行之后才会重置.</span>
<span class="token comment">// 当render异常时, 通过该变量可以决定是否清除render过程中的更新.</span>
<span class="token keyword">let</span> didScheduleRenderPhaseUpdate<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 在本次function的执行过程中, 是否再次发起了更新. 每一次调用function都会被重置</span>
<span class="token keyword">let</span> didScheduleRenderPhaseUpdateDuringThisPass<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token comment">// 在本次function的执行过程中, 重新发起更新的最大次数</span>
<span class="token keyword">const</span> <span class="token constant">RE_RENDER_LIMIT</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>调用Function Component函数的主要函数：<code>renderWithHooks</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> Component<span class="token punctuation">,</span> nextProps<span class="token punctuation">,</span> context<span class="token punctuation">,</span> renderExpirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">renderWithHooks</span><span class="token generic class-name"><span class="token operator">&lt;</span>Props<span class="token punctuation">,</span> SecondArg<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token function-variable function">Component</span><span class="token operator">:</span> <span class="token punctuation">(</span>p<span class="token operator">:</span> Props<span class="token punctuation">,</span> arg<span class="token operator">:</span> SecondArg<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> Props<span class="token punctuation">,</span>
  secondArg<span class="token operator">:</span> SecondArg<span class="token punctuation">,</span>
  nextRenderLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
  <span class="token comment">// --------------- 1. 设置全局变量 -------------------</span>
  <span class="token comment">// 当前渲染优先级</span>
  renderLanes <span class="token operator">=</span> nextRenderLanes<span class="token punctuation">;</span>
  <span class="token comment">// 切换全局指针到当前的Function Component对应的Fiber，然后再去执行render</span>
  currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>

  <span class="token comment">// 清除当前fiber的遗留状态</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token comment">// ----------- 2. 调用function,生成子级ReactElement对象 ----</span>
  <span class="token comment">// 指定dispatcher, 区分Mount和Update</span>
  <span class="token comment">// upadte的时候current是有值的</span>
  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
    current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> HooksDispatcherOnMount
      <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>

  <span class="token comment">// 执行function函数, 其中进行分析Hooks的使用</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> secondArg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --------------- 3. 重置全局变量,并返回 -------------------</span>

  <span class="token comment">// 执行function之后, 还原被修改的全局变量, 不影响下一次调用</span>
  renderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  currentlyRenderingFiber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  currentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  thenableIndexCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <div class="language-ts line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token keyword">const</span> HooksDispatcherOnMount<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  useContext<span class="token operator">:</span> readContext<span class="token punctuation">,</span>
  useEffect<span class="token operator">:</span> mountEffect<span class="token punctuation">,</span>
  useMemo<span class="token operator">:</span> mountMemo<span class="token punctuation">,</span>
  useReducer<span class="token operator">:</span> mountReducer<span class="token punctuation">,</span>
  useRef<span class="token operator">:</span> mountRef<span class="token punctuation">,</span>
  useState<span class="token operator">:</span> mountState<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> HooksDispatcherOnUpdate<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  useContext<span class="token operator">:</span> readContext<span class="token punctuation">,</span>
  useEffect<span class="token operator">:</span> updateEffect<span class="token punctuation">,</span>
  useMemo<span class="token operator">:</span> updateMemo<span class="token punctuation">,</span>
  useReducer<span class="token operator">:</span> updateReducer<span class="token punctuation">,</span>
  useRef<span class="token operator">:</span> updateRef<span class="token punctuation">,</span>
  useState<span class="token operator">:</span> updateState<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>从这里可以看出，我们的Hooks在Mount阶段和Update阶段的逻辑是不一样的。在Mount阶段和Update阶段他们是两个不同的定义。我们先来看Mount阶段的逻辑。在看之前我们先思考一些问题：React Hooks需要在Mount阶段做什么呢？就拿我们的<code>useState</code>来说：</p> <ol><li>我们需要初始化状态，并返回修改状态的方法，这是最基本的。</li> <li>我们要区分管理每个Hooks。</li> <li>提供一个数据结构去存放更新逻辑，以便后续每次更新可以拿到最新的值。</li></ol> <p><code>mountState</code>的实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">mountState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取当前的Hook节点，同时将当前Hook添加到Hook链表中</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 赋值初始 state</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initialState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    initialState <span class="token operator">=</span> <span class="token function">initialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> initialState<span class="token punctuation">;</span>
  <span class="token comment">// 声明一个链表来存放更新</span>
  <span class="token keyword">const</span> queue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 待更新</span>
    lanes<span class="token operator">:</span> NoLanes<span class="token punctuation">,</span> <span class="token comment">// 更新优先级</span>
    dispatch<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 更新函数</span>
    lastRenderedReducer<span class="token operator">:</span> basicStateReducer<span class="token punctuation">,</span> <span class="token comment">// 用于得到最新state的reducer</span>
    lastRenderedState<span class="token operator">:</span> <span class="token punctuation">(</span>initialState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 最后一次得到的state</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  hook<span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  <span class="token comment">// 创建dispatch 返回一个dispatch方法用来修改状态，并将此次更新添加update链表中</span>
  <span class="token keyword">const</span> dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span>
    BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">dispatchSetState</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    currentlyRenderingFiber<span class="token punctuation">,</span>
    queue<span class="token punctuation">,</span> <span class="token comment">// 通过函数柯里化，预置这个hook的更新队列</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回当前状态和修改状态的方法</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <h2 id="如何区分管理hooks"><a href="#如何区分管理hooks" class="header-anchor">#</a> 如何区分管理Hooks</h2> <p>初始化状态并返回状态和更新状态的方法，这个没有问题，源码也很清晰利用<code>initialState</code>来初始化状态，并且返回了状态和对应更新方法<code>return [hook.memoizedState, dispatch]</code>。那么我们来看看React是如何区分不同的Hooks的，这里我们可以从<code>mountState</code>里的<code>mountWorkInProgressHook</code>方法和Hook的类型定义中找到答案。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Hook</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  memoizedState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token comment">// useState中保存state信息</span>
  <span class="token comment">// useEffect中保存着effect对象；useMemo中保存的是缓存的值和deps；useRef中保存的是ref对象。</span>
  baseState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token comment">// 一次更新中，产生的最新state值</span>
  baseQueue<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 更新队列</span>
  queue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token comment">// 待更新队列</span>
  next<span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 下一个hook</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里除了<code>memoizedState</code>字段外，其他字段与之前介绍的<code>UpdateQueue</code>的数据结构字段意义类似。</p> <p>首先从Hook的类型定义中就可以看到，React对Hooks的定义是链表。也就是说我们组件里使用到的Hooks是通过链表来联系的，上一个Hook的<code>next</code>指向下一个Hook。这些Hooks节点是怎么利用链表数据结构串联在一起的呢？相关逻辑就在每个具体Mount阶段Hooks函数调用的<code>mountWorkInProgressHook</code>方法里：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token comment">// 新建链表结点</span>
  <span class="token keyword">const</span> hook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    baseState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    baseQueue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// workInProgressHook可以理解为链表的指针</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 特殊情况：指针指的是null，说明链表未建立，链表的头结点。</span>
    <span class="token comment">// 让指针指向hook</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一般情况：指针指的不是链表的开头</span>
    <span class="token comment">// 把新的hook赋值给当前workInProgressHook的next并让当前的指针指向下一个钩子</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <p>上面创建的Hook结构中，通过<code>next</code>指针，实现了一个<strong>无环的单向链表</strong>。产生的Hook对象依次排列，形成链表存储到函数组件<code>fiber.memoizedState</code>上。</p> <p>在产生Hook对象过程中，有一个十分重要的指针：<code>workInProgressHook</code>，它通过记录当前生成（更新）的Hook对象，来指向在组件中当前调用到哪个Hook函数了。每调用一次Hook函数，就将这个指针的指向移到该Hook函数产生的Hook对象上。</p> <p>在Mount阶段，每当我们调用Hooks方法，比如<code>useState</code>，<code>mountState</code>就会调用<code>mountWorkInProgressHook</code>来创建一个Hook节点，并把它添加到Hooks链表上。</p> <h2 id="如何返回最新的值"><a href="#如何返回最新的值" class="header-anchor">#</a> 如何返回最新的值</h2> <p><code>useState</code>是使用了一个<code>queue</code>链表来存放每一次的更新。以便后面的Update阶段可以返回最新的状态。每次我们调用<code>dispatch</code>的时候，就会形成一个新的<code>updata</code>对象，添加到<code>queue</code>链表上，而且这个是一个<strong>循环链表</strong>。整个过程可以概括为：</p> <ol><li>创建<code>update</code>。</li> <li>将<code>update</code>加入<code>hook.queue</code>中。</li> <li>开启调度。</li></ol> <div class="custom-block tip"><p class="custom-block-title">TIPS</p> <p>使用环形链表的意义：</p> <p>整个环形链表变量我们叫它<code>queue</code>，使得<code>queue.pending = update</code>，那么此时<code>queue.pending</code>的最近一次更新，就是<code>update</code>，最早的一次更新是<code>update.next</code>，这样就快速定位到最早的一次更新了。如果是单链表，想找到最早的一次更新，需要一层一层往下找。</p> <ul><li><code>queue.pending</code>指向最近一次更新</li> <li><code>queue.pending.next</code>指向第一次更新</li></ul></div> <p><code>dispatchSetState</code>方法的实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">dispatchSetState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  fiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  queue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  action<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建更新的对象</span>
  <span class="token keyword">const</span> update<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    lane<span class="token punctuation">,</span>
    action<span class="token punctuation">,</span> <span class="token comment">// 我们需要更新的值</span>
    hasEagerState<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否有提前计算的状态</span>
    eagerState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">//</span>
    next<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRenderPhaseUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// render 阶段触发的更新 会去创建和更新循环链表</span>
    <span class="token function">enqueueRenderPhaseUpdate</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 备用的 fiber</span>
    <span class="token keyword">const</span> alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      fiber<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// update队列不存在，意味可以在进入渲染阶段之前就可以计算下一个状态。</span>
      <span class="token comment">// 计算进入渲染阶段之前的下一个阶段的 state，如果新 state 与 当前状态相同，则退出渲染</span>
      <span class="token keyword">const</span> lastRenderedReducer <span class="token operator">=</span> queue<span class="token punctuation">.</span>lastRenderedReducer<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastRenderedReducer <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> prevDispatcher<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentState<span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>lastRenderedState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> eagerState <span class="token operator">=</span> <span class="token function">lastRenderedReducer</span><span class="token punctuation">(</span>currentState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
          update<span class="token punctuation">.</span>hasEagerState <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          update<span class="token punctuation">.</span>eagerState <span class="token operator">=</span> eagerState<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">(</span>eagerState<span class="token punctuation">,</span> currentState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在更新对象上存储下一个状态，以及用于计算的reducer。</span>
            <span class="token comment">// 如果reducer在进入渲染阶段没有被修改，那么就可以使用eager状态了无需再次调用reducer。</span>
            <span class="token function">enqueueConcurrentHookUpdateAndEagerlyBailout</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Suppress the error. It will throw again in the render phase.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// enqueueConcurrentHookUpdate -&gt; 调用getRootForUpdatedFiber找到当前节点的root节点。</span>
    <span class="token comment">// 获取当前 fiber，根据优先级区分同步任务和异步任务，同步任务应立即同步执行，最先渲染出来，异步任务走scheduler</span>
    <span class="token comment">// scheduleUpdateOnFiber 去调度执行更新任务</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">enqueueConcurrentHookUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> update<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">entangleTransitionUpdate</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">markUpdateInDevTools</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// react/packages/react-reconciler/src/ReactFiberHooks.new.js</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">enqueueRenderPhaseUpdate</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  queue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  update<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  didScheduleRenderPhaseUpdateDuringThisPass <span class="token operator">=</span> didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is the first update. Create a circular list.</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>调用多次<code>setCount</code>后count Hook节点的状态：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <div class="custom-block tip"><p class="custom-block-title">TIPS</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  fiber<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> alternate<span class="token punctuation">.</span>lanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>fiber.lanes === NoLanes</code>意味着<code>fiber</code>上不存在<code>update</code>；我们已经知道，通过<code>update</code>计算state发生在声明阶段，这是因为该Hook上可能存在多个不同优先级的<code>update</code>，最终state的值由多个<code>update</code>共同决定。但是当<code>fiber</code>上不存在<code>update</code>，则调用阶段创建的<code>update</code>为该Hook上第一个<code>update</code>，在声明阶段计算state时也只依赖于该<code>update</code>，完全不需要进入声明阶段再计算state。</p> <p>这样做的好处是：如果计算出的state与该Hook之前保存的state一致，那么完全不需要开启一次调度。即使计算出的state与该Hook之前保存的state不一致，在声明阶段也可以直接使用调用阶段已经计算出的state。</p></div> <p>在Hooks节点上面，会通过链表来存放所有的历史更新操作。以便在Update阶段可以通过这些更新获取到最新的值返回给我们。这就是在第一次调用<code>useState</code>之后，每次更新都能返回最新值的原因。然后我们来看看Update阶段，也就是看一下我们的<code>useState</code>是如何利用现有的信息，去给我们返回最新的最正确的值的。<code>updateState</code>实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">updateState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">updateReducer</span><span class="token punctuation">(</span>basicStateReducer<span class="token punctuation">,</span> <span class="token punctuation">(</span>initialState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到，<code>updateState</code>底层调用的其实就是<code>updateReducer</code>，因为我们调用<code>useState</code>的时候，并不会传入<code>reducer</code>，所以这里会默认传递一个<code>basicStateReducer</code>进去。我们先看看这个<code>basicStateReducer</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">basicStateReducer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">,</span> action<span class="token operator">:</span> BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">:</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在使用<code>useState(action)</code>的时候，<code>action</code>通常会是一个值，而不是一个方法。所以<code>basicStateReducer</code>要做的其实就是将这个<code>action</code>返回。</p> <p>对于更新阶段，说明上一次<code>workInProgress</code>树已经赋值给了<code>current</code>树。存放hooks信息的<code>memoizedState</code>，此时已经存在<code>current</code>树上。对于一次函数组件更新，当再次执行hooks函数的时候，比如<code>useState(0)</code>，首先要从<code>current</code>的hooks中找到与当前<code>workInProgressHook</code>，对应的<code>currentHooks</code>，然后复制一份<code>currentHooks</code>给<code>workInProgressHook</code>，接下来hooks函数执行的时候，把最新的状态更新到<code>workInProgressHook</code>，保证hooks状态不丢失。</p> <p><code>updateReducer</code>的实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">updateReducer</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
  initialArg<span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span>
  init<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">I</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取当前正在工作中的 Hook，即 workInProgressHook</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span>queue<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token string">'Should have a queue. This is likely a bug in React. Please file an issue.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  queue<span class="token punctuation">.</span>lastRenderedReducer <span class="token operator">=</span> reducer<span class="token punctuation">;</span>
  <span class="token comment">// currentHook 全局变量，当前 fiber 上的 hook 列表</span>
  <span class="token keyword">const</span> current<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">(</span>currentHook<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> baseQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>baseQueue<span class="token punctuation">;</span> <span class="token comment">// 基础更新队列（初始为null）</span>
  <span class="token comment">// 尚未处理的最后一个待处理更新（初始值为null）</span>
  <span class="token keyword">const</span> pendingQueue <span class="token operator">=</span> queue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
  <span class="token comment">// 如果有待处理的更新，但此时还没有更新的队列在处理，将待处理的更新添加到已有的基础队列的后面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>baseQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将待处理的更新添加基础队列的后面，维护环形链表</span>
      <span class="token keyword">const</span> baseFirst <span class="token operator">=</span> baseQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      <span class="token keyword">const</span> pendingFirst <span class="token operator">=</span> pendingQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      baseQueue<span class="token punctuation">.</span>next <span class="token operator">=</span> pendingFirst<span class="token punctuation">;</span>
      pendingQueue<span class="token punctuation">.</span>next <span class="token operator">=</span> baseFirst<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// pendingQueue赋值给baseQueue</span>
    current<span class="token punctuation">.</span>baseQueue <span class="token operator">=</span> baseQueue <span class="token operator">=</span> pendingQueue<span class="token punctuation">;</span>
    queue<span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 在处理「更新」的过程中没有产生新的 update，根据优先级来处理 更新队列(baseQueue)上的update</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// queue.pending为最新的update，next则为第一个update</span>
    <span class="token keyword">const</span> first <span class="token operator">=</span> baseQueue<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">let</span> newState <span class="token operator">=</span> current<span class="token punctuation">.</span>baseState<span class="token punctuation">;</span>

    <span class="token keyword">let</span> newBaseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newBaseQueueFirst <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newBaseQueueLast <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> update <span class="token operator">=</span> first<span class="token punctuation">;</span>
    <span class="token comment">// 根据优先级处理环形链表  baseQueue 上的 update</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       * 对低优先级的 update 进行处理：
       * 1、当前的 update 将会被跳过
       * 2、将当前的 update 拷贝一份，添加到更新队列的尾部
       */</span>
      <span class="token keyword">const</span> updateLane <span class="token operator">=</span> <span class="token function">removeLanes</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>lane<span class="token punctuation">,</span> OffscreenLane<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> isHiddenUpdate <span class="token operator">=</span> updateLane <span class="token operator">!==</span> update<span class="token punctuation">.</span>lane<span class="token punctuation">;</span>

      <span class="token comment">// 具体如何判断是否需要跳过这里不讨论</span>
      <span class="token keyword">const</span> shouldSkipUpdate <span class="token operator">=</span> isHiddenUpdate
        <span class="token operator">?</span> <span class="token operator">!</span><span class="token function">isSubsetOfLanes</span><span class="token punctuation">(</span><span class="token function">getWorkInProgressRootRenderLanes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> updateLane<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token operator">!</span><span class="token function">isSubsetOfLanes</span><span class="token punctuation">(</span>renderLanes<span class="token punctuation">,</span> updateLane<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldSkipUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 优先级不足。跳过此更新。</span>
        <span class="token keyword">const</span> clone<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          lane<span class="token operator">:</span> updateLane<span class="token punctuation">,</span>
          action<span class="token operator">:</span> update<span class="token punctuation">.</span>action<span class="token punctuation">,</span>
          hasEagerState<span class="token operator">:</span> update<span class="token punctuation">.</span>hasEagerState<span class="token punctuation">,</span>
          eagerState<span class="token operator">:</span> update<span class="token punctuation">.</span>eagerState<span class="token punctuation">,</span>
          next<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newBaseQueueLast <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newBaseQueueFirst <span class="token operator">=</span> newBaseQueueLast <span class="token operator">=</span> clone<span class="token punctuation">;</span>
          <span class="token comment">// 如果这是第一个跳过更新，之前的“状态” 就是新的基础“状态”，因为被跳过的更新不会去执行reducer。</span>
          newBaseState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          newBaseQueueLast <span class="token operator">=</span> newBaseQueueLast<span class="token punctuation">.</span>next <span class="token operator">=</span> clone<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新队列中剩余的优先级。</span>
        currentlyRenderingFiber<span class="token punctuation">.</span>lanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>
          currentlyRenderingFiber<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span>
          updateLane<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">markSkippedUpdateLanes</span><span class="token punctuation">(</span>updateLane<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 对高优先级的 update 进行处理：
         * 1、赋值一份当前的 update 进行备份
         * 2、调用 reducer 计算出新的  state
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newBaseQueueLast <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> clone<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个更新将被提交之后我们永远不想取消提交它。使用NoLane，</span>
            <span class="token comment">// 因为0是所有位掩码的子集，所以这永远不会被上面的检查跳过。</span>
            lane<span class="token operator">:</span> NoLane<span class="token punctuation">,</span>
            action<span class="token operator">:</span> update<span class="token punctuation">.</span>action<span class="token punctuation">,</span>
            hasEagerState<span class="token operator">:</span> update<span class="token punctuation">.</span>hasEagerState<span class="token punctuation">,</span>
            eagerState<span class="token operator">:</span> update<span class="token punctuation">.</span>eagerState<span class="token punctuation">,</span>
            next<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          newBaseQueueLast <span class="token operator">=</span> newBaseQueueLast<span class="token punctuation">.</span>next <span class="token operator">=</span> clone<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> action <span class="token operator">=</span> update<span class="token punctuation">.</span>action<span class="token punctuation">;</span> <span class="token comment">// 我们传入的值，如：setCount(2)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>hasEagerState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果这个reducer已经计算就直接用</span>
          newState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>eagerState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 使用 reducer 计算新的 state</span>
          newState <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 获取链表上的下一个 update</span>
      update <span class="token operator">=</span> update<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> update <span class="token operator">!==</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过是否遍历到头结点作为结束条件</span>

    <span class="token comment">// 继续维持循环链表状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newBaseQueueLast <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newBaseState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 链表成环</span>
      newBaseQueueLast<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token punctuation">(</span>newBaseQueueFirst<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 前后的 state 不同时标识变化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">is</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">markWorkInProgressReceivedUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 更新队列上的update 处理完后，在 hook 对象行挂载新的 state 和 update queue</span>
    hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseState <span class="token operator">=</span> newBaseState<span class="token punctuation">;</span>
    hook<span class="token punctuation">.</span>baseQueue <span class="token operator">=</span> newBaseQueueLast<span class="token punctuation">;</span>

    queue<span class="token punctuation">.</span>lastRenderedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>baseQueue <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有更新队列，优先级置为NoLanes</span>
    queue<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>dispatch<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回新的 state 和  dispatch 函数</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br></div></div><div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <ol><li><p>问题一：这里不是执行最后一个<code>action</code>不就可以了嘛？（用优先队列保存所有更新）</p> <details class="custom-block details"><summary>DETAILS</summary> <p>原因很简单，<code>useState</code>逻辑和<code>useReducer</code>差不多。如果第一个参数是一个函数，会引用上一次<code>update</code>产生的<code>state</code>，所以需要循环调用，每一个<code>update</code>的<code>reducer</code>，如果<code>setCount(1)</code>是这种情况，那么只用更新值，如果是<code>setCount(count =&gt; count + 1)</code>，那么传入上一次的<code>state</code>得到最新<code>state</code>。</p></details></li> <li><p>问题二：什么情况下会有优先级不足的情况？</p> <details class="custom-block details"><summary>DETAILS</summary> <p>这种情况，一般会发生在，当我们调用<code>setCount</code>时候，调用<code>scheduleUpdateOnFiber</code>渲染当前组件时，又产生了一次新的更新，所以把最终执行<code>reducer</code>更新<code>state</code>任务交给下一次更新。</p></details></li></ol> <p>对更新队列上的<code>update</code>进行处理时，会根据优先级的高低分别做不同的处理：</p> <ol><li><p>对于低优先级的<code>update</code>：</p> <ul><li>低优先级的<code>update</code>拷贝一份，将其添加到<strong>新的</strong>更新队列尾部。</li> <li>不会计算新的state。</li></ul></li> <li><p>对于高优先级的<code>update</code></p> <ul><li>拷贝当前的<code>update</code>，将其添加到<strong>新的</strong>更新队列的尾部。</li> <li>调用<code>reducer</code>计算新的<code>state</code>。</li></ul></li></ol> <p><code>updateWorkInProgressHook</code>的实现：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token comment">// 这里在workInProgressHook之外，引入了一个新的概念：currentHook，指的是当前 fiber 上的 hook 列表</span>
  <span class="token keyword">let</span> nextCurrentHook<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Hook<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果 currentHook = null 证明它是第一个hooks</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextCurrentHook <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      nextCurrentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 不是第一个hooks，那么指向下一个 hooks</span>
    nextCurrentHook <span class="token operator">=</span> currentHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> nextWorkInProgressHook<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Hook<span class="token punctuation">;</span>
  <span class="token comment">// 特殊情况：链表开头。如果当前的指针指向为空，说明为开头。注意这里判断的是workInProgressHook</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 第一次执行hooks</span>
    <span class="token comment">// 这里应该注意一下，当函数组件更新也是调用 renderWithHooks , memoizedState属性是置空的</span>
    nextWorkInProgressHook <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不是链表开头，那么会让nextWorkInProgressHook等于当前链表指针的next</span>
    nextWorkInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 这个模块是为了让workInProgressHook正常地指向下一个链表节点（因为workInProgressHook不是环形链表）</span>
  <span class="token comment">// 正常情况：初始化nextWorkInProgressHook后，nextWorkInProgressHook不为空</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextWorkInProgressHook <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个情况说明 renderWithHooks 执行 过程发生多次函数组件的执行，我们暂时先不考虑</span>
    <span class="token comment">// 这部分逻辑就是正常将workInProgressHook指针指向下一个元素</span>
    workInProgressHook <span class="token operator">=</span> nextWorkInProgressHook<span class="token punctuation">;</span>

    <span class="token comment">// nextWorkInProgressHook在这个方法里不再用到，但是一个全局变量，其他地方可能用到。</span>
    nextWorkInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    currentHook <span class="token operator">=</span> nextCurrentHook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 特殊情况：初始化nextWorkInProgressHook后，nextWorkInProgressHook仍然为空</span>
    <span class="token comment">// 可能有两种情况：</span>
    <span class="token comment">// 1.workInProgressHook为空（代表链表为空），currentlyRenderingFiber.memoizedState为空</span>
    <span class="token comment">// 2.workInProgressHook不为空，当前指针指向了链表的尾部，所以workInProgressHook.next为空，</span>
    <span class="token comment">// 导致nextWorkInProgressHook为空。</span>

    <span class="token comment">// 不管链表为空，还是指向了结尾，抽象意义上都是指向了链表结尾。</span>
    <span class="token comment">// 这两种情况，最后都执行了workInProgressHook = newHook;</span>

    <span class="token comment">// Clone from the current hook.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextCurrentHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Rendered more hooks than during the previous render.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    currentHook <span class="token operator">=</span> nextCurrentHook<span class="token punctuation">;</span>

    <span class="token keyword">const</span> newHook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      memoizedState<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>
      baseState<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseState<span class="token punctuation">,</span>
      baseQueue<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseQueue<span class="token punctuation">,</span>
      queue<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>queue<span class="token punctuation">,</span>
      next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 处理链表为空的情况</span>
    <span class="token comment">// 这里要注意，如果nextWorkInProgressHook不为空，workInProgressHook也一定不为空。</span>
    <span class="token comment">// 所以这里隐含了一个条件：workInProgressHook和nextWorkInProgressHook都为空。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 链表为空，就需要把第一个元素赋值给指针，让链表指针正常</span>
      currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前指针指向了链表的尾部的情况</span>
      workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><div class="img-container" data-v-a458ecf0><div class="img-wrapper" style="width:;height:;max-width:100px;max-height:100px;" data-v-a458ecf0><img src="/image-default.png" alt="image-default" class="image-default" data-v-a458ecf0></img></div></div> <ol><li>首先如果是第一次执行hooks函数，那么从<code>current</code>树上取出<code>memoizedState</code>，也就是旧的hooks。</li> <li>然后声明变量<code>nextWorkInProgressHook</code>，这里应该值得注意，正常情况下，一次<code>renderWithHooks</code>执行，<code>workInProgress</code>上的<code>memoizedState</code>会被置空，hooks函数顺序执行，<code>nextWorkInProgressHook</code>应该一直为<code>null</code>，那么什么情况下<code>nextWorkInProgressHook</code>不为<code>null</code>，也就是当一次<code>renderWithHooks</code>执行过程中，执行了多次函数组件。这里面的逻辑，实际就是判定，如果当前函数组件执行后，当前函数组件的还是处于渲染优先级，说明函数组件又有了新的更新任务，那么循坏执行函数组件。这就造成了上述的，<code>nextWorkInProgressHook</code>不为<code>null</code>的情况。</li> <li>最后复制<code>current</code>的hooks，把它赋值给<code>workInProgressHook</code>，用于更新新的一轮hooks状态。</li></ol> <p>问：为什么要克隆当前Hook，为什么不直接复用？</p> <details class="custom-block details"><summary>DETAILS</summary> <p>这样可以保证Fiber上的Hook“原件”完整，某些情况下（比如<code>useEffect</code>要对比新旧Hook的依赖），在构建当前Hook的同时，仍需要上一次Hook的信息。</p></details> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ol><li><p>React如何管理区分Hooks？</p> <p>React通过单链表来管理Hooks，按Hooks的执行顺序依次将Hook节点添加到链表中。</p> <blockquote><p>那么 React 怎么知道哪个 state 对应哪个 useState？答案是 React 靠的是 Hook 调用的顺序。</p></blockquote></li> <li><p><code>useState</code>如何在每次渲染时，返回最新的值？</p> <p>每个Hook节点通过<strong>循环链表</strong>记住所有的更新操作，在Update阶段会依次执行<code>update</code><strong>循环链表</strong>中的所有更新操作，最终拿到最新的state返回。</p></li> <li><p>为什么不能在条件语句等中使用Hooks？</p> <p>因为在下一次函数组件更新，Hooks链表结构会被破坏，<code>current</code>树的<code>memoizedState</code>缓存Hooks信息，和当前<code>workInProgress</code>不一致，如果涉及到读取state等操作，就会发生异常。</p></li> <li><p>Hooks通过什么来证明唯一性？</p> <p>通过Hooks链表顺序。</p></li></ol> <p>Hooks挂载数据的数据结构叫做<code>Fiber</code>，在16版本前，是直接遍历vdom，通过dom api增删改dom的方式来渲染的。引入了<code>fiber</code>架构后，把vdom树转换成<code>fiber</code>链表，然后再渲染<code>fiber</code>。那么Hooks挂载在哪个<code>fiber</code>节点呢？Hooks挂载在<code>renderwithHooks</code>函数中的<code>workInProgress</code>对象上，保存在<code>workInProgress</code>的<code>memorizedState</code>上，它是一个通过<code>next</code>串联的链表。<code>useEffect</code>、<code>useState</code>的实现相对要复杂一点，因为涉及到调度，Hooks会把这些<code>effect</code>串联成一个<code>updateQueue</code>的链表。</p> <p>参考链接</p> <ul><li><a href="https://react.docschina.org/docs/hooks-rules.html" target="_blank" rel="nofollow noopener noreferrer">Hook 规则<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6844904080758800392" target="_blank" rel="nofollow noopener noreferrer">React Hooks源码解析，原来这么简单～<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/cj9551/article/details/121464419" target="_blank" rel="nofollow noopener noreferrer">06-React hooks 源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/409390496" target="_blank" rel="nofollow noopener noreferrer">React Fiber 简介 —— React 背后的算法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/7023891902126620679" target="_blank" rel="nofollow noopener noreferrer">React Hooks 源码解读之 useReducer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/567534059" target="_blank" rel="nofollow noopener noreferrer">React 原理系列 —— Hook 是这样工作的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新: </span> <span class="time">2023年12月20日 15:04:55</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/pages/articles/react/react-hookxue-xi.html" class="prev">
            React Hook学习
          </a></span> <span class="next"><a href="/pages/articles/react/chang-yong-hook.html">
            常用Hook
          </a></span></p></div> <div class="comments-wrapper" style="display:none;"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/pages/articles/react/usestateyuan-ma-xue-xi.html#usestate的使用" class="sidebar-link reco-side-usestate的使用" data-v-70334359>useState的使用</a></li><li class="level-2" data-v-70334359><a href="/pages/articles/react/usestateyuan-ma-xue-xi.html#源码分析" class="sidebar-link reco-side-源码分析" data-v-70334359>源码分析</a></li><li class="level-2" data-v-70334359><a href="/pages/articles/react/usestateyuan-ma-xue-xi.html#如何区分管理hooks" class="sidebar-link reco-side-如何区分管理hooks" data-v-70334359>如何区分管理Hooks</a></li><li class="level-2" data-v-70334359><a href="/pages/articles/react/usestateyuan-ma-xue-xi.html#如何返回最新的值" class="sidebar-link reco-side-如何返回最新的值" data-v-70334359>如何返回最新的值</a></li><li class="level-2" data-v-70334359><a href="/pages/articles/react/usestateyuan-ma-xue-xi.html#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:50%;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.18b294a3.js" defer></script><script src="/assets/js/3.7300aef9.js" defer></script><script src="/assets/js/1.cfd142c1.js" defer></script><script src="/assets/js/103.595e0ae4.js" defer></script><script src="/assets/js/11.ae2268d9.js" defer></script>
  </body>
</html>
